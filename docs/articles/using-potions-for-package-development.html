<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using potions for package development • potions</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Using potions for package development">
<meta property="og:description" content="potions">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">potions</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/quick-start-guide.html">Quick start guide</a>
    </li>
    <li>
      <a href="../articles/using-potions-for-package-development.html">Using potions for package development</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using potions for package development</h1>
            
      
      
      <div class="hidden name"><code>using-potions-for-package-development.Rmd</code></div>

    </div>

    
    
<p>Resetting global options within R packages is inherently risky, and
is therefore discouraged by CRAN:</p>
<blockquote>
<p>Ideally, the R code files should only directly assign R objects and
definitely should not call functions with side effects such as require
and options.<br><br><em>Writing R Extensions, Section 1.1.5 (Package
subdirectories)</em></p>
</blockquote>
<p>Despite this, <code><a href="https://rdrr.io/r/base/options.html" class="external-link">options()</a></code> are an important part of the R
language, and so it is not uncommon for packages to rely on bespoke
options that can be set by their users. In weighing up architectural
decisions about how their packages should work, there are three basic
solutions that developers can choose:</p>
<ul>
<li>Where a developer needs to be able to call static information across
multiple functions, an efficient solution is to use
<code>sysdata.rda</code>, which supports internal use of named objects
while avoiding <code><a href="https://rdrr.io/r/base/options.html" class="external-link">options()</a></code> completely.</li>
<li>Where a function relies on information stored in
<code><a href="https://rdrr.io/r/base/options.html" class="external-link">options()</a></code>, and for which there is no override, it is
possible to temporarily reset <code><a href="https://rdrr.io/r/base/options.html" class="external-link">options()</a></code> within a function.
In these cases, it is best practice to restore the initial state using
<code><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit()</a></code> (See <a href="https://adv-r.hadley.nz/functions.html#on-exit" class="external-link">Advanced R section
6.7.4</a>).</li>
<li>Finally, where there is a need for dynamic, package-wide options
that can be changed by the developer or the user, packages such as
<code>{potions}</code> or <a href="https://cran.r-project.org/package=settings" class="external-link">settings</a> can be
valuable.</li>
</ul>
<p><code>{potions}</code> makes it easy for the developer to quickly
call and update information using simple syntax. It is also written to
avoid conflicts with other slots in <code><a href="https://rdrr.io/r/base/options.html" class="external-link">options()</a></code>, meaning it
will not affect global behaviour of other functions or packages. To use
<code>{potions}</code> in a package development situation, create a file
in the <code>R</code> directory called <code>onLoad.R</code>, containing
the following code:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">.onLoad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">libname</span>, <span class="va">pkgname</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">pkgname</span> <span class="op">==</span> <span class="st">"packagenamehere"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">potions</span><span class="fu">::</span><span class="fu"><a href="../reference/brew.html">brew</a></span><span class="op">(</span>.pkg <span class="op">=</span> <span class="st">"packagenamehere"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This is important because it tells <code>{potions}</code> that you
are developing a package, what that package is called, and where future
calls to <code><a href="../reference/brew.html">brew()</a></code> from within that package should place their
data. It is also possible to add defaults here, e.g.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">.onLoad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">libname</span>, <span class="va">pkgname</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">pkgname</span> <span class="op">==</span> <span class="st">"packagenamehere"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu">potions</span><span class="fu">::</span><span class="fu"><a href="../reference/brew.html">brew</a></span><span class="op">(</span></span>
<span>      <span class="va">n_attempts</span> <span class="op">==</span> <span class="fl">5</span>,</span>
<span>      <span class="va">verbose</span> <span class="op">==</span> <span class="cn">TRUE</span>,</span>
<span>      .pkg <span class="op">=</span> <span class="st">"packagenamehere"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level3">
<h3 id="building-a-wrapper-function">Building a wrapper function<a class="anchor" aria-label="anchor" href="#building-a-wrapper-function"></a>
</h3>
<p>Often in a package you will want users to call your own configuration
function, rather than call <code><a href="../reference/brew.html">brew()</a></code> directly. This provides
greater control over the names &amp; types (classes) of data stored by
<code>{potions}</code>, which in turn gives you - the developer -
greater certainty when calling those data <em>within</em> your package
via <code><a href="../reference/pour.html">pour()</a></code>.</p>
<p>For example, you might want to specify that a specific argument is
supplied as numeric:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">packagename_config</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fontsize</span> <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">fontsize</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html" class="external-link">abort</a></span><span class="op">(</span><span class="st">"Argument `fontsize` must be a number"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="../reference/brew.html">brew</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fontsize <span class="op">=</span> <span class="va">fontsize</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>An additional benefit of writing a wrapper function is to allow users
to provide their own <code>config</code> file. The easiest way to do
this is to support a <code>file</code> argument within your own
function, then pass this directly to <code><a href="../reference/brew.html">brew()</a></code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">packagename_config</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">file</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">file</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/brew.html">brew</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">file</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This approach is risky, however, as it doesn’t allow any checks. An
alternative is to intercept the file, run your own checks, then pass the
result as data:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">packagename_config</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">file</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">file</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">potions</span><span class="fu">::</span><span class="fu"><a href="../reference/read_config.html">read_config</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="co"># add any checks to `data` that are needed here</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="fu">rlang</span><span class="fu">::</span><span class="fu"><a href="https://rlang.r-lib.org/reference/abort.html" class="external-link">abort</a></span><span class="op">(</span><span class="st">"Not all entries are named!"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="co"># pass to `brew`</span></span>
<span>    <span class="fu"><a href="../reference/brew.html">brew</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Martin Westgate.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
